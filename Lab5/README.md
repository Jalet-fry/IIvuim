# Lab 5 - Мониторинг USB-устройств

## Описание

Лабораторная работа №5 реализует систему мониторинга USB-устройств в Windows с использованием Windows API.

## Функциональность

### Основные возможности:

1. **Отслеживание подключения устройств**
   - Автоматическое обнаружение новых USB-устройств при подключении
   - Расширенная идентификация устройств:
     * Интеллектуальное определение названия (Friendly Name)
     * Определение типа устройства (HID, Дисковый накопитель, Мышь, и т.д.)
     * Отображение VID (Vendor ID) и PID (Product ID)
     * Определение производителя устройства
   - Определение возможности извлечения (извлекаемое/неизвлекаемое)

2. **Безопасное извлечение**
   - Программное безопасное извлечение USB-устройств
   - Проверка возможности извлечения устройства
   - Подтверждение операции извлечения

3. **Мониторинг отключения**
   - Отслеживание безопасного отключения устройства
   - Отслеживание небезопасного отключения устройства
   - Обработка отказа в безопасном извлечении

4. **Журнал событий**
   - Подробный лог всех операций с USB-устройствами
   - Временные метки для каждого события
   - Различные типы сообщений (подключение, отключение, извлечение)

5. **Поддержка модифицированных устройств**
   - Корректная работа с USB-устройствами, разбитыми на несколько дисков
   - Поддержка комбинированных устройств (CD-ROM + Flash)

## Демонстрируемые устройства

- **Мышь** - неизвлекаемое устройство (системное)
- **Флешка** - извлекаемое устройство с возможностью безопасного извлечения

## Архитектура

### Структура файлов:

```
Lab5/
├── usbdevice.h        - Класс USB-устройства
├── usbdevice.cpp      - Реализация класса устройства
├── usbmonitor.h       - Класс мониторинга (поток)
├── usbmonitor.cpp     - Реализация мониторинга
├── usbwindow.h        - Главное окно приложения
├── usbwindow.cpp      - Реализация UI
├── usbwindow.ui       - UI форма
└── README.md          - Документация
```

### Основные классы:

#### USBDevice
Класс представляет USB-устройство с его свойствами:
- Hardware ID
- Имя устройства (с интеллектуальным выбором из Friendly Name или Description)
- Vendor ID (VID) - идентификатор производителя
- Product ID (PID) - идентификатор продукта
- Производитель устройства
- Тип устройства (HID, Дисковый накопитель, Мышь, и т.д.)
- Путь к устройству
- Флаг возможности извлечения
- Статус безопасного извлечения

**Ключевые методы:**
- `eject()` - безопасное извлечение устройства
- `isEjectable()` - проверка возможности извлечения
- `isSafelyEjected()` - проверка статуса извлечения
- `determineDeviceType()` - определение типа устройства по классу

**Геттеры:**
- `getName()` - получить имя устройства
- `getVID()` - получить Vendor ID
- `getPID()` - получить Product ID
- `getManufacturer()` - получить производителя
- `getDeviceType()` - получить тип устройства

#### USBMonitor
Класс-поток для мониторинга USB-устройств:
- Работает в отдельном потоке
- Регистрирует скрытое окно для получения системных уведомлений
- Обрабатывает события Windows (WM_DEVICECHANGE)
- Отправляет сигналы Qt при изменениях

**Обрабатываемые события:**
- `DBT_DEVICEARRIVAL` - подключение устройства
- `DBT_DEVICEREMOVECOMPLETE` - отключение устройства
- `DBT_DEVICEQUERYREMOVEFAILED` - отказ в извлечении

**Сигналы:**
- `deviceConnected()` - устройство подключено
- `deviceDisconnected()` - устройство отключено
- `deviceEjected()` - устройство извлечено
- `ejectFailed()` - отказ в извлечении
- `logMessage()` - сообщение для журнала

#### USBWindow
Графический интерфейс для взаимодействия с пользователем:
- Таблица подключенных устройств
- Кнопки управления (обновить, извлечь)
- Журнал событий с временными метками
- Статусная строка

## Используемые Windows API

### Библиотеки:
- **setupapi.lib** - работа с устройствами
- **Cfgmgr32.lib** - конфигурация устройств

### Ключевые функции:

1. **Получение информации об устройствах:**
   - `SetupDiGetClassDevsW()` - получить список устройств класса
   - `SetupDiEnumDeviceInfo()` - перечислить устройства
   - `SetupDiGetDeviceRegistryPropertyW()` - получить свойства устройства:
     * `SPDRP_FRIENDLYNAME` - дружественное имя устройства
     * `SPDRP_DEVICEDESC` - описание устройства
     * `SPDRP_MFG` - производитель
     * `SPDRP_CLASS` - класс устройства
     * `SPDRP_HARDWAREID` - идентификатор оборудования (VID/PID)
     * `SPDRP_CAPABILITIES` - возможности устройства

2. **Работа с интерфейсами устройств:**
   - `SetupDiEnumDeviceInterfaces()` - перечислить интерфейсы
   - `SetupDiGetDeviceInterfaceDetailW()` - получить детали интерфейса

3. **Регистрация уведомлений:**
   - `RegisterDeviceNotificationW()` - зарегистрировать уведомления
   - `UnregisterDeviceNotification()` - отменить регистрацию

4. **Безопасное извлечение:**
   - `CM_Request_Device_EjectW()` - запрос на извлечение устройства

5. **Обработка окон:**
   - `RegisterClassExW()` - регистрация класса окна
   - `CreateWindowW()` - создание окна
   - `DefWindowProcW()` - обработка сообщений по умолчанию

## Особенности реализации

### Многопоточность
- Мониторинг работает в отдельном потоке (`QThread`)
- Главный UI работает в главном потоке
- Синхронизация через сигналы/слоты Qt

### Обработка событий
- Скрытое окно регистрируется для получения системных уведомлений
- События обрабатываются через `WM_DEVICECHANGE`
- Статический указатель для доступа из callback функции

### Безопасность
- Проверка возможности извлечения перед операцией
- Подтверждение пользователя перед извлечением
- Обработка ошибок извлечения

## Инструкция по использованию

1. **Запуск приложения:**
   - Откройте главное меню
   - Нажмите кнопку "ЛР 5"
   - Откроется окно мониторинга USB-устройств

2. **Просмотр устройств:**
   - В таблице отображаются все подключенные USB-устройства
   - Для каждого устройства показано: номер, имя, PID, возможность извлечения

3. **Подключение устройства:**
   - Подключите USB-устройство (мышь или флешку)
   - Устройство автоматически появится в таблице
   - В журнале отобразится событие подключения

4. **Безопасное извлечение:**
   - Выберите извлекаемое устройство в таблице
   - Нажмите кнопку "Безопасно извлечь"
   - Подтвердите операцию в диалоге
   - После успешного извлечения физически отключите устройство

5. **Отключение устройства:**
   - При безопасном извлечении - в журнале отобразится "Безопасно отключено"
   - При прямом отключении - в журнале отобразится "Небезопасно отключено"

6. **Обновление списка:**
   - Нажмите кнопку "Обновить список" для принудительного обновления

7. **Очистка журнала:**
   - Нажмите "Очистить журнал" для удаления старых записей

## Обработка ошибок

### Отказ в извлечении
Может произойти если:
- Устройство используется системой
- Открыты файлы с устройства
- Запущены программы с устройства

**Действия:**
1. Закрыть все программы, использующие устройство
2. Закрыть все файлы с устройства
3. Повторить попытку извлечения

### Небезопасное отключение
Если устройство было отключено физически без безопасного извлечения:
- Система зафиксирует небезопасное отключение
- В журнале появится предупреждение
- Возможна потеря данных (для накопителей)

## Технические детали

### GUID интерфейса USB
```cpp
GUID_DEVINTERFACE_USB_DEVICE
```
Используется для фильтрации только USB-устройств.

### Флаги возможностей устройства
```cpp
CM_DEVCAP_REMOVABLE - устройство является извлекаемым
```

### Коды возврата операций
```cpp
CR_SUCCESS - операция успешна
CR_* - различные коды ошибок
```

## Зависимости

- Qt 5.x или выше
- Windows API (Windows 7 и выше)
- setupapi.lib
- Cfgmgr32.lib

## Компиляция

Файл проекта `IIvuim.pro` уже настроен с необходимыми библиотеками:
```qmake
win32: LIBS += -lsetupapi -lCfgmgr32
```

## Последние улучшения

### Расширенная идентификация устройств (октябрь 2025)
Система была значительно улучшена для более точной идентификации USB-устройств. Теперь вместо неинформативного "Составное USB устройство" отображается:
- Конкретное название устройства (Friendly Name)
- Тип устройства (HID, Дисковый накопитель, Мышь, и т.д.)
- VID и PID для точной идентификации
- Производитель устройства

**Подробности:**
- См. `УЛУЧШЕНИЯ_USB_МОНИТОРИНГА.md` - полное техническое описание
- См. `ЧТО_ИЗМЕНИЛОСЬ.txt` - краткая справка с примерами

**Пример улучшенного вывода:**
```
Было:
  Составное USB устройство [PID: C534]

Стало:
  HID-совместимая мышь [Тип: HID-устройство] [VID: 046D, PID: C534] [Производитель: Logitech]
```

## Автор

Реализация Lab5 - Система мониторинга USB-устройств

## Лицензия

Учебный проект

