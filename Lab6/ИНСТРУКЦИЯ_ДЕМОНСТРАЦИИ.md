# Инструкция по демонстрации Lab6 - Bluetooth

## Краткая информация

**Что реализовано:**
- ✅ Обнаружение Bluetooth адаптера (Windows Native API)
- ✅ Сканирование всех Bluetooth устройств
- ✅ Отображение подключенных устройств (наушники, мышь, телефон)
- ✅ Информация о типах устройств и статусах
- ✅ Многопоточное сканирование (не блокирует UI)

**Почему Windows API:**
Qt 5.5.1 НЕ поддерживает Bluetooth на Windows. Поддержка появилась только в Qt 5.12+.

## Сценарий демонстрации (5-7 минут)

### 1. Запуск и проверка адаптера (1 мин)

**Действия:**
```bash
cd C:\QT_projects\IIvuim
.\release\SimpleLabsMenu.exe
```

1. Нажать **"Lab 6 - Bluetooth"**
2. Показать журнал инициализации:

```
[20:22:50] === Инициализация Windows Bluetooth ===
[20:22:50] Локальное устройство: DESKTOP-XXXXXX
[20:22:50] Адрес: XX:XX:XX:XX:XX:XX
[20:22:50] ✓ Bluetooth адаптер активен!

[20:22:50] === WINDOWS BLUETOOTH MANAGER INIT ===
[20:22:50] ✓ Windows Bluetooth API доступен

ИНФОРМАЦИЯ О ЛОКАЛЬНОМ АДАПТЕРЕ:
  Имя: DESKTOP-XXXXXX
  MAC: XX:XX:XX:XX:XX:XX

ПРОВЕРКА ПОДКЛЮЧЕННЫХ УСТРОЙСТВ:
  Найдено: 3
  1. Sony WH-1000XM4 (XX:XX:XX:XX:XX:XX)
  2. Logitech MX Master (XX:XX:XX:XX:XX:XX)
  3. Galaxy S20 (XX:XX:XX:XX:XX:XX)
```

**Объяснить:**
- Программа использует Windows Bluetooth API напрямую
- Сразу показывает информацию о локальном адаптере
- Автоматически обнаруживает уже подключенные устройства

---

### 2. Демонстрация подключенных устройств (1 мин)

**Действия:**
1. Нажать кнопку **"Обновить адаптер"**

**Показать в логе:**
```
[20:23:00] === Обновление информации об адаптере ===
[20:23:00] Локальное устройство: DESKTOP-XXXXXX
[20:23:00] Адрес: XX:XX:XX:XX:XX:XX
[20:23:00] ✓ Bluetooth адаптер активен
[20:23:00] Подключенных устройств: 3
[20:23:00]   • Sony WH-1000XM4 (XX:XX:XX:XX:XX:XX)
[20:23:00]   • Logitech MX Master (XX:XX:XX:XX:XX:XX)
[20:23:00]   • Galaxy S20 (XX:XX:XX:XX:XX:XX)
```

**Объяснить:**
- Это устройства, которые СЕЙЧАС подключены к ноутбуку
- Windows API видит их даже без сканирования
- Можно обновлять информацию в любой момент

---

### 3. Сканирование устройств (2-3 мин)

**Действия:**
1. Нажать **"Сканировать"**
2. Показать процесс сканирования в логе:

```
[20:23:15] === Начинаем сканирование ===
[20:23:15] ═══════════════════════════════════════════
[20:23:15] === WINDOWS BLUETOOTH SCAN STARTED ===
[20:23:15] ═══════════════════════════════════════════

ПАРАМЕТРЫ СКАНИРОВАНИЯ:
  • Таймаут: 5.12 сек
  • Поиск сопряженных: ДА
  • Поиск подключенных: ДА
  • Активное сканирование: ДА

Поиск устройств...
─────────────────────────────────────────

╔═══════════════════════════════════════╗
║     ✓ НАЙДЕНО УСТРОЙСТВО!             ║
╚═══════════════════════════════════════╝
  Имя: Sony WH-1000XM4
  MAC: XX:XX:XX:XX:XX:XX
  Тип: Аудио/Видео
  Статус: 🔵 Подключено 🔗 Сопряжено 
─────────────────────────────────────────

╔═══════════════════════════════════════╗
║     ✓ НАЙДЕНО УСТРОЙСТВО!             ║
╚═══════════════════════════════════════╝
  Имя: Logitech MX Master
  MAC: XX:XX:XX:XX:XX:XX
  Тип: Периферия
  Статус: 🔵 Подключено 🔗 Сопряжено 💾 Запомнено 
─────────────────────────────────────────

[Дождаться завершения]

═══════════════════════════════════════════
=== НАЙДЕНО УСТРОЙСТВ: 3 ===
═══════════════════════════════════════════

[20:23:20] === Сканирование завершено ===
[20:23:20] Найдено устройств: 3
```

**Объяснить:**
- Сканирование выполняется в отдельном потоке
- UI не зависает (можно прокручивать лог)
- Сканирование длится ~5 секунд
- Находит как подключенные, так и сопряженные устройства

---

### 4. Анализ таблицы устройств (2 мин)

**Показать таблицу:**

| № | Имя устройства | MAC адрес | Тип | Статус |
|---|---------------|-----------|-----|--------|
| 1 | Sony WH-1000XM4 | 00:1D:3B:... | Аудио/Видео | 🔵 Подключено 🔗 Сопряжено |
| 2 | Logitech MX Master | 5C:BA:37:... | Периферия | 🔵 Подключено 🔗 Сопряжено 💾 Запомнено |
| 3 | Galaxy S20 | A4:C1:38:... | Телефон | 🔗 Сопряжено 💾 Запомнено |

**Объяснить каждую колонку:**

**№** - Порядковый номер найденного устройства

**Имя устройства** - Понятное имя (как в настройках Windows)

**MAC адрес** - Уникальный идентификатор Bluetooth устройства

**Тип** - Категория устройства (определяется по Class of Device):
- Аудио/Видео: наушники, колонки
- Периферия: мышь, клавиатура
- Телефон: смартфоны
- Компьютер: ноутбуки, ПК
- И другие

**Статус** - Состояние устройства:
- 🔵 **Подключено** - сейчас активно используется
- 🔗 **Сопряжено** - добавлено в систему, может подключиться
- 💾 **Запомнено** - система знает это устройство

---

### 5. Повторное сканирование (1 мин)

**Действия:**
1. Нажать "Сканировать" еще раз
2. Показать, что:
   - Таблица очищается
   - Новое сканирование выполняется
   - Результаты воспроизводимы

**Объяснить:**
- Можно сканировать многократно
- Результаты стабильны
- Нет утечек памяти

---

## Технические детали для вопросов

### Почему не используется Qt Bluetooth?

**Ответ:**
Qt Bluetooth в версии 5.5.1 не поддерживает Windows. Попытка использования приводит к ошибке:
```
UnsupportedPlatformError: Платформа не поддерживается
```

Полноценная поддержка Windows появилась в Qt 5.12+. Поэтому используем Windows Native API, аналогично Lab4 (камера) и Lab5 (USB).

---

### Какие Windows API используются?

**Ответ:**
Из библиотеки `BluetoothAPIs.h`:

1. **BluetoothFindFirstRadio** / **BluetoothFindRadioClose**
   - Поиск локальных Bluetooth адаптеров

2. **BluetoothGetRadioInfo**
   - Информация о радио (имя, MAC, производитель)

3. **BluetoothFindFirstDevice** / **BluetoothFindNextDevice**
   - Перебор всех Bluetooth устройств
   - Аналог `readdir` для файловой системы

4. **BLUETOOTH_DEVICE_SEARCH_PARAMS**
   - Параметры поиска
   - Флаги: сопряженные, подключенные, новые
   - Таймаут сканирования

Библиотеки: `Bthprops.lib`, `ws2_32.lib`

---

### Почему сканирование занимает время?

**Ответ:**
Bluetooth сканирование - это радио-процесс:
1. Адаптер переключается в режим обнаружения
2. Посылает inquiry запросы
3. Ждет ответы от устройств
4. Собирает информацию

Параметр `cTimeoutMultiplier = 4` задает таймаут:
- 4 × 1.28 секунды = ~5 секунд
- Можно увеличить для нахождения большего числа устройств
- Можно уменьшить для ускорения

---

### Как определяется тип устройства?

**Ответ:**
Bluetooth использует **Class of Device (CoD)** - 24-битное значение:

```
Биты 8-12: Major Device Class
- 0x01 = Компьютер
- 0x02 = Телефон
- 0x04 = Аудио/Видео
- 0x05 = Периферия
- и т.д.
```

Код в программе:
```cpp
DWORD majorClass = (deviceClass >> 8) & 0x1F;
switch (majorClass) {
    case 0x01: return "Компьютер";
    case 0x02: return "Телефон";
    case 0x04: return "Аудио/Видео";
    case 0x05: return "Периферия";
    // ...
}
```

---

### Почему используется многопоточность?

**Ответ:**
Функция `BluetoothFindFirstDevice` с флагом `fIssueInquiry = TRUE` **блокирует поток** на время сканирования (~5 секунд).

Если выполнить в главном потоке:
- ❌ UI замерзает
- ❌ Нельзя прокручивать лог
- ❌ Плохой UX

Решение - `QThread`:
```cpp
class BluetoothScanWorker : public QThread {
    void run() override {
        // Сканирование здесь
    }
};
```

✅ UI остается отзывчивым
✅ Можно работать с интерфейсом во время сканирования
✅ Можно закрыть окно (поток корректно завершится)

---

## Сравнение с Lab5 (USB)

| Аспект | Lab5 (USB) | Lab6 (Bluetooth) |
|--------|-----------|------------------|
| **API** | SetupDi (USB) | BluetoothAPIs |
| **Уведомления** | WM_DEVICECHANGE | Сканирование |
| **Скорость** | Мгновенно | ~5 сек |
| **Потоки** | Один | Отдельный для сканирования |
| **Горячее подключение** | Да, автоматически | Нет, нужно сканировать |
| **Библиотеки** | setupapi.lib, Cfgmgr32.lib | Bthprops.lib, ws2_32.lib |

---

## Возможные вопросы и ответы

**В:** Можно ли подключаться к устройствам?
**О:** В текущей версии - нет. Реализован только мониторинг. Подключение через RFCOMM - будущая функция.

**В:** Почему некоторые устройства не видны?
**О:** Windows API может не показывать некоторые уже подключенные устройства. Это нормальное поведение. Такие устройства видны в системных настройках, но не всегда через API.

**В:** Можно ли сканировать BLE (Bluetooth Low Energy)?
**О:** Текущая реализация работает с Classic Bluetooth. Для BLE нужны другие API функции (например, Windows.Devices.Bluetooth.Advertisement в UWP).

**В:** Почему Lab6 работает, а Qt Bluetooth нет?
**О:** Qt 5.5.1 слишком старый. Qt Bluetooth для Windows требует Qt 5.12+ и работает через Windows 10 Bluetooth APIs.

---

## Итоговая демонстрация (резюме)

**Что показали:**
1. ✅ Прямая работа с Windows Bluetooth API
2. ✅ Обнаружение локального адаптера
3. ✅ Отображение подключенных устройств (наушники, мышь, телефон)
4. ✅ Полноценное сканирование с многопоточностью
5. ✅ Определение типов и статусов устройств
6. ✅ Стабильная работа при повторных сканированиях

**Технические достижения:**
- Обход ограничений Qt 5.5.1
- Использование низкоуровневого Windows API
- Многопоточность для UI отзывчивости
- Подробное логирование всех операций

**Практическое применение:**
- Мониторинг Bluetooth устройств
- Диагностика подключений
- Учебный проект для изучения Windows Bluetooth API

---

## Дополнительные материалы

**README.md** - Полная документация проекта
**TESTING.md** - Тестовые сценарии и проверки

**Полезные ссылки:**
- Windows Bluetooth API: https://docs.microsoft.com/en-us/windows/win32/bluetooth/
- Bluetooth CoD: https://www.bluetooth.com/specifications/assigned-numbers/

**Спасибо за внимание!**
