# Lab6 - Полная реализация

## ✅ ЧТО РЕАЛИЗОВАНО

### 1. Настоящее RFCOMM подключение
**Файлы:** `bluetoothconnection.h/cpp`

**Что делает:**
- Инициализация Winsock2 для Bluetooth
- Создание AF_BTH сокета (Bluetooth Socket)
- Подключение через RFCOMM протокол (Serial Port Profile)
- Парсинг MAC адреса
- Отправка/прием данных через сокет
- Отключение и очистка

**API:**
```cpp
WSAStartup()                    // Инициализация Winsock
socket(AF_BTH, SOCK_STREAM, BTHPROTO_RFCOMM)  // Создание Bluetooth сокета
connect()                       // Подключение к устройству  
send()                          // Отправка данных
recv()                          // Прием данных
closesocket()                   // Закрытие соединения
WSACleanup()                    // Очистка
```

**Логирование:**
- Каждый API вызов логируется
- Параметры и результаты
- Коды ошибок расшифровываются

---

### 2. Отправка файлов через fsquirt
**Файлы:** `bluetoothfilesender.h/cpp`

**Метод 1: fsquirt.exe**
- Запускает Windows Bluetooth File Transfer Wizard
- Передает путь к файлу
- Пользователь выбирает устройство
- Работает для ЛЮБЫХ устройств

**Метод 2: Windows Shell**
- Открывает Проводник с файлом
- Пользователь использует контекстное меню

**Логирование:**
- Команды запуска
- Результаты
- Ошибки

---

### 3. Система логирования (5 файлов!)
**Файлы:** `bluetoothlogger.h/cpp`

**Создается 5 файлов в каждой сессии:**

```
Session_<дата_время>/
├── main.log        - ВСЕ логи
├── scan.log        - Только сканирование
├── connect.log     - Только подключения
├── send.log        - Только отправка файлов
└── api_calls.log   - Только Windows API вызовы
```

**Каждый лог включает:**
- Временную метку с миллисекундами
- Уровень (DEBUG, INFO, WARNING, ERROR, SUCCESS)
- Категорию
- Сообщение

**Логируется:**
- Инициализация Winsock
- Создание сокета
- Парсинг MAC адреса
- Подключение
- Отправка данных
- Ошибки с кодами
- Результаты API вызовов

---

### 4. Мониторинг устройств
**Файлы:** `windowsbluetoothmanager.h/cpp`

- Сканирование через `BluetoothFindFirstDevice`
- Отображение в таблице
- Определение типов устройств
- Статусы (подключено/сопряжено/запомнено)

---

### 5. UI с кнопками управления

**Кнопки:**
- **Сканировать** - поиск устройств
- **Подключить** - RFCOMM подключение к выбранному устройству
- **Отключить** - закрытие RFCOMM соединения
- **Отправить файл** - отправка через fsquirt
- **Обновить адаптер** - просмотр подключенных устройств
- **Очистить лог** - очистка UI лога

**Состояния:**
- Кнопки активируются/деактивируются по состоянию
- "Подключить" доступна если не подключено
- "Отключить" доступна если подключено
- "Отправить файл" всегда доступна (работает без RFCOMM)

---

## 📊 Как это работает

### Сценарий 1: Отправка БЕЗ подключения (через fsquirt)

1. Выберите устройство
2. Нажмите "Отправить файл"
3. Выберите файл
4. Откроется Windows мастер
5. Выберите устройство в мастере
6. На телефоне примите файл
7. ✓ Файл передан!

**Логи:**
- `send.log` - процесс отправки
- `api_calls.log` - CreateProcess(fsquirt.exe)
- `main.log` - всё вместе

---

### Сценарий 2: Подключение через RFCOMM + отправка

1. Выберите устройство
2. Нажмите "Подключить"
3. Ждите 5-30 секунд
4. Если успешно - кнопка "Отключить" активна
5. Теперь можно отправлять данные напрямую

**Логи:**
- `connect.log` - процесс подключения
- `api_calls.log` - все API вызовы:
  - WSAStartup
  - socket()
  - connect()
  - send()
  - recv()
  - closesocket()
  - WSACleanup
- `main.log` - всё вместе

---

## 🔍 Детальность логирования

### В connect.log будет:

```
═══════════════════════════════════════
ПОДКЛЮЧЕНИЕ К BLUETOOTH УСТРОЙСТВУ
═══════════════════════════════════════
Устройство: Dc.Stone
MAC: F8:6B:FA:2D:7C:FA

═══════════════════════════════════════
ИНИЦИАЛИЗАЦИЯ WINSOCK
═══════════════════════════════════════
[DEBUG] API CALL: WSAStartup(MAKEWORD(2,2))
[SUCCESS] API RESULT: WSAStartup → SUCCESS
[SUCCESS] ✓ Winsock версия: 2.2

ШАГ 1: Создание Bluetooth сокета
[DEBUG] API CALL: socket(AF_BTH, SOCK_STREAM, BTHPROTO_RFCOMM)
[SUCCESS] API RESULT: socket → SUCCESS - Socket Handle = 0x...
[SUCCESS] ✓ Bluetooth сокет создан
[DEBUG] Socket handle: 0x...

ШАГ 2: Парсинг MAC адреса устройства
[DEBUG] Парсинг MAC адреса: F8:6B:FA:2D:7C:FA
[SUCCESS] ✓ MAC адрес распознан
[DEBUG] Байты: F8 6B FA 2D 7C FA

ШАГ 3: Настройка параметров подключения
[DEBUG] Параметры:
[DEBUG]   • addressFamily: AF_BTH
[DEBUG]   • btAddr: 0x...
[DEBUG]   • serviceClassId: RFCOMM_PROTOCOL_UUID
[DEBUG]   • port: BT_PORT_ANY (автоматически)

ШАГ 4: Инициация подключения
[WARNING] ⏱ Это может занять 5-30 секунд...
[DEBUG] API CALL: connect(socket=0x..., addr=F8:6B:FA:2D:7C:FA)

[Если успешно:]
[SUCCESS] API RESULT: connect → SUCCESS - Подключено!
[SUCCESS] ✓✓✓ ПОДКЛЮЧЕНИЕ УСПЕШНО! ✓✓✓
[SUCCESS] Установлено соединение с: Dc.Stone
[SUCCESS] Адрес: F8:6B:FA:2D:7C:FA
[SUCCESS] Можно отправлять данные!

[Если ошибка:]
[ERROR] API RESULT: connect → FAILED - WSAECONNREFUSED (10061): Подключение отклонено
[ERROR] ✗ ПОДКЛЮЧЕНИЕ НЕ УДАЛОСЬ
[ERROR] Ошибка: WSAECONNREFUSED (10061): Подключение отклонено

ВОЗМОЖНЫЕ ПРИЧИНЫ:
1. Устройство не поддерживает Serial Port Profile (SPP)
2. Устройство не в режиме обнаружения
3. Bluetooth выключен на устройстве
4. Устройство отклонило подключение
5. Таймаут подключения
```

---

### В api_calls.log будет:

```
[21:52:30.123] [DEBUG] [WinAPI] API CALL: WSAStartup(MAKEWORD(2,2))
[21:52:30.125] [SUCCESS] [WinAPI] API RESULT: WSAStartup → SUCCESS
[21:52:30.126] [DEBUG] [WinAPI] API CALL: socket(AF_BTH, SOCK_STREAM, BTHPROTO_RFCOMM)
[21:52:30.128] [SUCCESS] [WinAPI] API RESULT: socket → SUCCESS - Socket Handle = 0x00000124
[21:52:30.130] [DEBUG] [WinAPI] API CALL: connect(socket=0x124, addr=F8:6B:FA:2D:7C:FA)
[21:52:35.456] [ERROR] [WinAPI] API RESULT: connect → FAILED - WSAECONNREFUSED
```

---

### В send.log будет:

```
═══════════════════════════════════════
ОТПРАВКА ФАЙЛА НА BLUETOOTH УСТРОЙСТВО
═══════════════════════════════════════
Целевое устройство: Dc.Stone
MAC адрес: F8:6B:FA:2D:7C:FA
[DEBUG] Подключено: НЕТ
[DEBUG] Сопряжено: ДА

[SUCCESS] ✓ Устройство сопряжено
Открытие диалога выбора файла...
[SUCCESS] ✓ Выбран файл: music.mp3
[DEBUG] Полный путь: C:/Users/.../music.mp3
[DEBUG] Размер: 5742763 байт (5.48 MB)

═══════════════════════════════════════
ЗАПУСК ОТПРАВКИ ЧЕРЕЗ WINDOWS API
═══════════════════════════════════════
Метод: fsquirt.exe (Windows Bluetooth File Transfer)

[DEBUG] API CALL: CreateProcess(fsquirt.exe)
[DEBUG] Команда: fsquirt.exe /send "C:\Users\...\music.mp3"
[DEBUG] Запуск процесса...
[SUCCESS] API RESULT: CreateProcess → SUCCESS - fsquirt запущен
[SUCCESS] ✓ Мастер отправки файлов запущен!
```

---

## 🚀 Как использовать

### Вариант А: Отправка через fsquirt (проще, всегда работает)

1. Выберите устройство
2. Нажмите "Отправить файл"
3. В мастере выберите устройство
4. Файл отправится

**Логи:** `send.log`, `api_calls.log`

---

### Вариант Б: RFCOMM подключение + прямая отправка

1. Выберите устройство
2. Нажмите "Подключить"
3. Ждите (5-30 сек)
4. Если успешно - можно отправлять данные напрямую

**Логи:** `connect.log`, `api_calls.log`

**Примечание:** Многие устройства (особенно телефоны) не поддерживают входящие RFCOMM подключения. В этом случае используйте Вариант А.

---

## 📁 Структура логов после запуска

```
Lab6_BluetoothLogs/
└── Session_20251014_215251/
    ├── main.log        ← ВСЕ логи
    ├── scan.log        ← Только сканирование
    ├── connect.log     ← Только подключения (RFCOMM)
    ├── send.log        ← Только отправка файлов
    └── api_calls.log   ← Только Windows API вызовы
```

---

## 🔧 Сборка

```bash
cd C:\QT_projects\IIvuim
qmake IIvuim.pro
mingw32-make
```

Или в Qt Creator: `Build → Rebuild All`

---

## 🎯 Итого

### Реализовано:
- ✅ RFCOMM подключение (настоящее!)
- ✅ Отправка файлов (через fsquirt - работает всегда)
- ✅ Детальное логирование (5 файлов!)
- ✅ Логирование каждого API вызова
- ✅ Мониторинг устройств
- ✅ Полная UI интеграция

### Не реализовано:
- ❌ Автовоспроизведение (требует приложение на телефоне)
- ❌ OBEX протокол напрямую (сложно, fsquirt делает это за нас)

### Достаточно для ЛР?
**✅ ДА!** Базовое задание + отправка файлов полностью реализованы.

---

## 📝 Примечание

**RFCOMM подключение может НЕ работать** с некоторыми устройствами (особенно телефонами), т.к. они не ожидают входящих SPP подключений. Это нормально - используйте отправку через fsquirt.

**Логи покажут ПОЧЕМУ** не удалось подключиться:
- Устройство не поддерживает SPP
- Устройство отклонило подключение
- Таймаут

Всё это будет в `connect.log` с деталями!


